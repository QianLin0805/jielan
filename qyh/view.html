<!doctype html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name = "format-detection" content = "telephone=no">
<title>提交建议</title>
<link rel="stylesheet" href="css/style.css" />
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/js.js"></script>
<style type="text/css">
.wrap{width: 100%;overflow: hidden;}
h3{height: 40px;line-height: 40px;text-indent: 10px;font-size: 16px;color: #333;}
h3 span{margin-left: 10px;font-size: 14px;color: #f00;display: none;}
.title{padding: 0 10px;height: 45px;background: #fff;}
.title input{width: 100%;height: 100%;line-height: 20px;word-wrap:break-word;font-size: 15px;}
.content{padding: 10px;background: #fff;overflow: hidden;}
.content textarea{font-size: 15px;width: 100%;height: 120px;line-height: 30px;}
#sub{height: 40px;line-height: 40px;background: #f14545;color: #fff;font-size: 16px;border-radius: 5px;display: block;text-align: center;margin: 50px 10px 0;}
</style>
</head>
<body>
<div class="wrap" ng-app="myApp" ng-controller="dataCtrl">
	<h3>主题<span>请输入主题</span></h3>
	<p class="title"><input type="text" placeholder="请输入主题" maxlength="18" /></p>
	<h3>建议内容 <span>请输入内容</span></h3>
	<div class="content"><textarea name="" id="" placeholder="请输入内容" maxlength="140"></textarea></div>
	<a id="sub">提交</a>
</div>
<p class="tishi">已提交成功，将尽快与您联系！</p>
</body>
</html>
<script type="text/javascript" src="js/angular.js"></script>
<script type="text/javascript">
var code=getQueryString('code');
var sCorpID=getQueryString('state');
var userId,userName;
if(window.name){
	var info = (new Function("return "+ window.name))();
	userId = info.user;
}else{
	$.ajax({
		type:"POST",
		url:link+"getOAuth.do",
		async:false,
		data:{
			"coreId":sCorpID,
			"code":code
		},
		success:function(response){
			userId=response.resultContent.UserId;
		}
	});
}
angular.module('myApp',[]).controller('dataCtrl',function($scope,$http){
	$http({
		url: link+"findUser.do",
		data: {
			"sCorpID":sCorpID,
			"userId":userId
		},
	    method: 'POST',
	    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
	    transformRequest: function(obj) {
	        var str = [];
	        for(var p in obj)
	        str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
	        return str.join("&");
	    }
	}).success(function(response){
		userName=response.resultContent.name;
	});
});
document.onreadystatechange = function(){
	if(document.readyState == "complete"){
		var time;
		$('textarea').on('focus',function(){
			var that=$(this);
			if(navigator.platform=='iPhone'){
				var offsetTop=$('h3').eq(1).offset().top;
				setTimeout(function(){
					$(window).scrollTop(offsetTop);
				},400);
			}
			time=setInterval(function(){
				that.css('height',that.height()+that.scrollTop()+'px');
			},100);

		});
		$('textarea').on('blur',function(){
			clearInterval(time);
		});
		$('#sub').on('click',function(){
			if($('input').val()==''){
				$('h3').eq(0).children().show();
				setTimeout(function(){
					$('h3').eq(0).children().hide();
				},1000);
				return;
			}
			if($('textarea').val()==''){
				$('h3').eq(1).children().show();
				setTimeout(function(){
					$('h3').eq(1).children().hide();
				},1000);
				return;
			}
			var topic=$('input').val(),msg=$('textarea').val();
			$.ajax({
				type:"POST",
				url:link+"saveFeedBack.do",
				async:true,
				data:{
					"sCorpID":sCorpID,
					"userId":userId,
					"userName":userName,
					"title":topic,
					"msg":msg
				},
				success:function(response){
					if(response.resultCode!=200){
					$('.tishi').text('提交失败').show();
						tishi();
						return;
					}
					$('input,textarea').val('');
					$('.tishi').text('已提交成功，将尽快与您联系！').show();
					tishi();
				},
				error:function(){
					$('.tishi').text('提交失败').show();
					tishi();
				}
			});
		})
	}
}
window.onunload = function(){  
	var user = userId;
	window.name  = '{user:"'+user+'"}';
} 
</script>